<div class="row" tal:condition="show">
    <span class="tiles-actions" tal:condition="api.has_permission('edit')">
        <input type="hidden" id="grid-fieldname" value="" />
        <span id="tile-removed-alert" i18n:translate="">Tile removed.</span>
    </span>
    <div class="gridster">
        <ul>
            <tal:repeat tal:repeat="tile tiles">
                <li tal:define="url python:'url' in tile and tile['url'];
                                type python:'type' in tile and tile['type'];
                                use python:'use' in tile and tile['use'];
                                extra_style python: 'extra_style' in tile and tile['extra_style'];"
                    id="tile-${tile['row']}-${tile['col']}"
                    data-row="${tile['row']}"
                    data-col="${tile['col']}"
                    data-sizex="${tile['size_x']}"
                    data-sizey="${tile['size_y']}"
                    data-url="${url}"
                    data-use="${use}"
                    data-type="${type}"
                    data-extra-style="${extra_style}"
                    class="${tile['class']}"
                    style="${tile['style']}">

                    <span class="tile-actions" tal:condition="api.has_permission('edit')">
                        <span class="icon-move">&nbsp;</span>
                        <span class="tile-action"
                           onclick="javascript:window.gridbrowser('tile-${tile['row']}-${tile['col']}','/', 'link');"
                           onmousedown="return false;">
                            <span id="srcbrowser" title="Browse" class="icon-edit">&nbsp;</span>
                        </span>
                        <span class="cpick tile-action" title="Change color">
                            <span class="icon-tint">&nbsp;</span>
                        </span>
                        <span class="tile-action"
                           onclick="javascript:window.rm_tile('#tile-${tile['row']}-${tile['col']}');"
                           onmousedown="return false;">
                            <span title="Remove" class="icon-remove">&nbsp;</span>
                        </span>
                    </span>

                    <div class="tile-content">
                        <tal:content tal:condition="url">
                            <span tal:replace="structure tile_content(context, request, url=url, size_x=tile['size_x'], use=use, extra_style=extra_style)" />
                        </tal:content>
                    </div>
                </li>
            </tal:repeat>
        </ul>
    </div>
    <span class="tiles-actions" tal:condition="api.has_permission('edit')">
        <button id="save-tiles" class="btn" i18n:translate="">Save tiles</button>
        <span id="add-tile" class="tile-action icon-plus">&nbsp;</span>
    </span>
    <script>
      $(function(){
        if ($('.gridster ul').length > 0) {
            window.gridster = $(".gridster ul").gridster({
                widget_margins: [${margin_x}, ${margin_y}],
                widget_base_dimensions: [${dimension_x}, ${dimension_y}],
                serialize_params: function($w, wgd) {
                    return {
                        //html: $w.html(),
                        id: wgd.el[0].id,
                        col: wgd.col,
                        row: wgd.row,
                        size_x: wgd.size_x,
                        size_y: wgd.size_y,
                        'class': $w.attr('class'),
                        url: $w.attr('data-url'),
                        use: $w.attr('data-use'),
                        type: $w.attr('data-type'),
                        extra_style: $w.attr('data-extra-style'),
                        style: $w.attr('style').replace($w.attr('data-extra-style'), '')
                    };
                },
                draggable: {
                    stop: function(event, ui) {
                        //save_tiles();
                        event.preventDefault()
                    }
                }
            }).data('gridster').disable();
        }
        /*window.gridster.resize_widget_dimensions = function(options) {

            if (options.widget_margins) {
              this.options.widget_margins = options.widget_margins;
            }

            if (options.widget_base_dimensions) {
              this.options.widget_base_dimensions = options.widget_base_dimensions;
            }

            this.min_widget_width  = (this.options.widget_margins[0] * 2)
                + this.options.widget_base_dimensions[0];
            this.min_widget_height = (this.options.widget_margins[1] * 2)
                + this.options.widget_base_dimensions[1];

            var serializedGrid = this.serialize();
            this.$widgets.each($.proxy(function(i, widget) {
                var $widget = $(widget);
                var data = serializedGrid[i];
                this.resize_widget($widget, data.sizex, data.sizey);
            }, this));

            this.generate_grid_and_stylesheet();
            this.get_widgets_from_DOM();
            this.set_dom_grid_height();

            return false;
        };*/
        <tal:condition tal:condition="api.has_permission('edit')">
            window.gridster.enable();
        </tal:condition>
      });
    </script>
</div>
